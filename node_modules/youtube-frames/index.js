(function (g) {
  var ytdl = require('ytdl-core');
  var fs = require('fs');
  var spawn = require('child_process').spawn;

  const $ytvideo = function (youtubeURL, videoName, options = {}) {

    return new $ytvideo.init(youtubeURL, videoName, options);

  };

  // safely create directory
  const mkdirSync = function (dir) {
    if (!fs.existsSync(dir)) {
      fs.mkdirSync(dir);
    }
  };

  $ytvideo.prototype = {
    // Download video from YouTube
    download: function (path) {
      const self = this;
      self.path = path || './';

      if (self.path !== './' && self.path) {
        mkdirSync(self.path);
      }

      // create a promise
      self.prom = new Promise(function (resolve) {

        let video = ytdl(self.youtubeURL, { quality: self.quality}); //, filter: 'video' 
        let vpipe = video.pipe(fs.createWriteStream(`${self.path}/${self.videoName}_${self.quality}.mp4`));

        video.on('progress', function (chunkLength, downloaded, total) {

          const floatDownloaded = downloaded / total;
          console.log(`${self.videoName} - Download progress: ${parseFloat(floatDownloaded*100).toFixed(2)} %`);

        });

        video.on('error', function (err) {

          console.log("\nThere was an error downloading.\n");
          throw err;

        });

        video.on('end', function () {
          
          console.log(`\nFinished downloading: ${self.videoName}\n`);

        });

        video.on('info', function(data){
          console.log(data.length_seconds);
          self.length = data.length_seconds;
        });

        vpipe.on('finish', function () {

          console.log(`Finished writing ${self.videoName}_${self.quality}.mp4 to disk`);
          resolve();

        });
      });
      return self;
    },

    toFrames: function (fps, begin, end) {
      const self = this;
      
      self.fps = fps || 1;

      if (typeof self.fps !== 'number') {
        throw "fps argument must be a number"
      } else {
        self.fps = String(self.fps);
      }

      // spawn ffmpeg to get frames from video
      function getFrames() {
        begin = begin || 0;
        end = end || self.length;
        console.log(`Starting Video Frame Process of ${self.videoName}`);
        console.log(`Taking Frames from: ${begin}, to: ${end}`);

        let ffmpegProcess = spawn('ffmpeg', [
          '-i', `${self.path}/${self.videoName}_${self.quality}.mp4`,
          '-ss', `${begin}`,
          '-to', `${end}`,
          '-f', 'image2',
          '-bt', '20M',
          '-vf', `fps=${self.fps}`,
          `${self.path}/${self.videoName}%03d.jpg`,
          '-loglevel', 'panic',
          '-nostdin'
        ]);

        ffmpegProcess.stdout.on('data', (data) => {
          console.log(data.toString());
        });

        ffmpegProcess.stderr.on('error', (err) => {
          console.log(err.toString());
        });

        ffmpegProcess.stdout.on('close', () => {
          console.log(`Finished Video Frame Process of ${self.videoName}`);
        });
      };

      if (self.prom) {
        self.prom.then(getFrames);
      } else {
        getFrames();
      }

      return self;
    }
  };

  // this is the object created when you call $ytvideo
  $ytvideo.init = function (youtubeURL, videoName, options={}) {
    console.log(options);
    this.youtubeURL = youtubeURL;
    this.videoName = videoName || 'video';
    this.path = options.path || './';
    this.quality = options.quality || 'highest';
    this.length = 0;
  }

  $ytvideo.init.prototype = $ytvideo.prototype;

  g.$ytvideo = g.$yt = $ytvideo;

}(global));